#!/usr/bin/perl -w

eval 'exec /usr/bin/perl -w -S $0 ${1+"$@"}'
    if 0; # not running under some shell

use strict;
use Bio::Graphics::Browser2::UserDB;
use CGI qw(:standard);

our $VERSION = '$Id: gbrowse_login,v 1.1 2009-08-27 20:33:23 idavies Exp $';

umask 022;

my %actions  = map {$_=>1} param('action');
my %callback;

my $user     = param('user');
my $pass     = param('pass');
my $email    = param('email');
my $userid   = param('session');
my $remember = param('remember');

my $old      = param('old_val');
my $new      = param('new_val');
my $column   = param('column');

my $confirm  = param('confirm');
my $openid   = param('openid');
my $option   = param('option');

my $userdb = Bio::Graphics::Browser2::UserDB->new;

if($actions{list_openid}) {
    print header('application/json');
    $userdb->do_list_openid($user)  if $actions{list_openid};
    exit 0;
}

if($actions{confirm_openid}) {
    my $arg;
    my $print = -1;

    foreach(param('callback')) {
        $arg   = $_           if($print == -1);
        $callback{$arg} = $_  if($print ==  1);
        $print = $print * -1;
    }

    print header('application/json');
    $userdb->do_confirm_openid(\%callback, $userid, $option);
    exit 0;
}

print header();

$userdb->do_validate			($user, $pass, $remember)				if $actions{validate};
$userdb->do_add_user_check		($user, $email, $pass, $userid)			if $actions{add_user_check};
$userdb->do_add_user			($user, $email, $pass, $userid)			if $actions{add_user};
$userdb->do_edit_confirmation	($email, $option)						if $actions{edit_confirmation};
$userdb->do_confirm_account		($user, $confirm)						if $actions{confirm_account};
$userdb->do_edit_details		($user, $column, $old, $new)			if $actions{edit_details};
$userdb->do_email_info			($email)								if $actions{email_info};
$userdb->do_delete_user			($user, $pass)							if $actions{delete_user};

$userdb->do_add_openid_user		($user, $openid, $userid, $remember)	if $actions{add_openid_user};
$userdb->do_check_openid		($openid, $userid, $option)				if $actions{check_openid};
$userdb->do_change_openid		($user, $pass, $openid, $option)		if $actions{change_openid};

exit 0;

__END__
